<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal & Admin System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --secondary-color: #10b981; /* emerald-500 */
            --danger-color: #ef4444; /* red-500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0,0,0.1), 0 4px 6px -2px rgba(0, 0,0,0.05);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .tab-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            cursor: pointer;
            font-weight: 600;
        }
        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header / Navigation Bar -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 id="app-title" class="text-2xl font-bold text-gray-800 cursor-pointer" onclick="navigate('home')">
                Student & Admin Portal
            </h1>
            <div class="flex items-center space-x-4">
                <span id="user-display" class="text-gray-600 hidden"></span>
                <button id="logout-btn" class="text-sm text-red-500 hover:text-red-700 font-medium hidden" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="app-container" class="flex-grow p-4 md:p-8">
        <!-- Content will be rendered here by JavaScript -->
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white p-4 text-center text-sm">
        &copy; 2024 Student Management System. All rights reserved.
    </footer>

    <script>
        // --- DATA STRUCTURES (Simulated Database) ---
        let state = {
            isLoggedIn: false,
            user: null, // { username, role: 'admin' | 'student', studentId }
            currentPage: 'home',
            activeAdminTab: 'students'
        };

        const defaultData = {
            // Admin can edit this content via the admin panel
            homeContent: {
                title: "Welcome to the Academic Portal",
                body: "This is the central hub for managing student grades and attendance. Log in to access your dashboard or administration tools.",
                features: [
                    "Real-time Attendance Tracking",
                    "Secure Grade Reporting",
                    "Admin Content Management",
                    "Detailed Permission Logs"
                ]
            },
            // Initial Students
            students: [
                { id: 'S001', name: 'Alice Smith', username: 'alice', password: '123' },
                { id: 'S002', name: 'Bob Johnson', username: 'bob', password: '123' },
            ],
            // Initial Admin
            admins: [
                { id: 'A001', name: 'System Admin', username: 'admin', password: 'admin' }
            ],
            // Grades: { studentId: [{ subject: string, grade: string }] }
            grades: {
                'S001': [{ subject: 'Math', grade: 'A+' }, { subject: 'Science', grade: 'B' }],
                'S002': [{ subject: 'History', grade: 'C' }],
            },
            // Attendance: { studentId: [{ date: string, status: 'Present' | 'Absent' | 'Permission' | 'Daily Permission' | 'Permanent Permission', reason?: string }] }
            attendance: {
                'S001': [
                    { date: '2024-10-01', status: 'Present' },
                    { date: '2024-10-02', status: 'Absent' },
                    { date: '2024-10-03', status: 'Permission', reason: 'Doctor Appointment' },
                    { date: '2024-10-04', status: 'Present' },
                    { date: '2024-10-05', status: 'Permanent Permission', reason: 'Family Relocation' },
                    { date: '2024-10-06', status: 'Daily Permission', reason: 'Sick Day' },
                ],
                'S002': [
                    { date: '2024-10-01', status: 'Present' },
                    { date: '2024-10-02', status: 'Present' },
                ]
            }
        };

        let data = JSON.parse(localStorage.getItem('smsData')) || defaultData;

        // --- UTILITY FUNCTIONS ---

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('smsData', JSON.stringify(data));
        }

        // Generate unique IDs
        function generateId(prefix) {
            return prefix + Math.random().toString(16).slice(2, 8).toUpperCase();
        }

        // --- AUTHENTICATION ---

        function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            let user = null;
            let role = null;

            // Check Admins
            const admin = data.admins.find(a => a.username === username && a.password === password);
            if (admin) {
                user = admin;
                role = 'admin';
            }

            // Check Students
            const student = data.students.find(s => s.username === username && s.password === password);
            if (student) {
                user = student;
                role = 'student';
            }

            const messageBox = document.getElementById('login-message');
            if (user) {
                state.isLoggedIn = true;
                state.user = { ...user, role: role, studentId: student ? student.id : null };
                
                // Clear the form and navigate
                document.getElementById('login-form').reset();
                navigate(role === 'admin' ? 'admin' : 'student');
            } else {
                messageBox.textContent = 'Invalid username or password.';
                messageBox.className = 'text-center p-2 mt-4 bg-red-100 text-red-700 rounded-lg';
            }
            updateUI();
        }

        function logout() {
            state.isLoggedIn = false;
            state.user = null;
            navigate('home');
            updateUI();
        }

        // --- UI & NAVIGATION ---

        function updateUI() {
            const userDisplay = document.getElementById('user-display');
            const logoutBtn = document.getElementById('logout-btn');

            if (state.isLoggedIn) {
                userDisplay.textContent = `Welcome, ${state.user.name} (${state.user.role})`;
                userDisplay.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                userDisplay.classList.add('hidden');
                logoutBtn.classList.add('hidden');
            }
        }

        function navigate(page) {
            state.currentPage = page;
            renderPage();
        }

        function renderPage() {
            const container = document.getElementById('app-container');
            container.innerHTML = '';
            let content = '';

            if (!state.isLoggedIn && state.currentPage !== 'home' && state.currentPage !== 'login') {
                navigate('login');
                return;
            }

            switch (state.currentPage) {
                case 'home':
                    content = renderHomePage();
                    break;
                case 'login':
                    content = renderLoginPage();
                    break;
                case 'student':
                    content = renderStudentDashboard();
                    break;
                case 'admin':
                    content = renderAdminPanel();
                    break;
                default:
                    content = render404Page();
            }
            container.innerHTML = content;

            // Execute post-render scripts (e.g., setting up Admin Panel tabs)
            if (state.currentPage === 'admin') {
                renderAdminContent();
            }
        }
        
        // --- PAGE RENDERING FUNCTIONS ---

        function renderHomePage() {
            const home = data.homeContent;
            return `
                <div class="max-w-4xl mx-auto card p-8 text-center">
                    <h2 class="text-4xl font-extrabold text-gray-900 mb-4">${home.title}</h2>
                    <p class="text-xl text-gray-600 mb-8">${home.body}</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                        ${home.features.map(f => `
                            <div class="bg-blue-50 p-6 rounded-lg shadow-inner flex items-start space-x-3">
                                <svg class="w-6 h-6 text-blue-600 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                <span class="text-gray-700 font-medium">${f}</span>
                            </div>
                        `).join('')}
                    </div>

                    <div class="space-x-4">
                        <button class="btn-primary" onclick="navigate('login')">
                            Student/Admin Login
                        </button>
                    </div>
                </div>
            `;
        }

        function renderLoginPage() {
            return `
                <div class="max-w-md mx-auto card p-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Secure Login</h2>
                    <form id="login-form" onsubmit="event.preventDefault(); login();">
                        <div class="mb-4">
                            <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                            <input type="text" id="login-username" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="login-password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <button type="submit" class="btn-primary w-full">Log In</button>
                    </form>
                    <div id="login-message"></div>
                </div>
            `;
        }

        function renderStudentDashboard() {
            if (state.user.role !== 'student') { return renderUnauthorized(); }
            const studentId = state.user.studentId;
            const studentGrades = data.grades[studentId] || [];
            const studentAttendance = data.attendance[studentId] || [];

            // Calculate Attendance Summary
            const summary = studentAttendance.reduce((acc, entry) => {
                if (entry.status === 'Present') acc.present++;
                else if (entry.status === 'Absent') acc.absent++;
                else if (entry.status.includes('Permission')) acc.permission++;
                return acc;
            }, { present: 0, absent: 0, permission: 0 });

            return `
                <div class="max-w-5xl mx-auto space-y-8">
                    <h2 class="text-3xl font-bold text-gray-800">Student Dashboard: ${state.user.name}</h2>

                    <!-- Attendance Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        ${renderSummaryCard('Present', summary.present, 'bg-green-100 text-green-700', 'bg-green-500')}
                        ${renderSummaryCard('Absent', summary.absent, 'bg-red-100 text-red-700', 'bg-red-500')}
                        ${renderSummaryCard('Permission', summary.permission, 'bg-yellow-100 text-yellow-700', 'bg-yellow-500')}
                    </div>

                    <!-- Grades Table -->
                    <div class="card p-6">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Academic Grades</h3>
                        ${studentGrades.length > 0 ? `
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${studentGrades.map(g => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${g.subject}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${g.grade}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<p class="text-gray-500">No grades recorded yet.</p>'}
                    </div>

                    <!-- Detailed Attendance Log -->
                    <div class="card p-6">
                        <h3 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Detailed Attendance & Permissions</h3>
                        ${studentAttendance.length > 0 ? `
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details/Reason</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${studentAttendance.reverse().map(a => `
                                        <tr class="${a.status === 'Absent' ? 'bg-red-50' : a.status.includes('Permission') ? 'bg-yellow-50' : ''}">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${a.date}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${a.status}</td>
                                            <td class="px-6 py-4 text-sm text-gray-700">${a.reason || 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<p class="text-gray-500">No attendance data recorded yet.</p>'}
                    </div>
                </div>
            `;
        }

        function renderSummaryCard(title, value, bgColor, barColor) {
            return `
                <div class="card p-6 ${bgColor} overflow-hidden relative">
                    <div class="text-sm font-medium text-gray-600 mb-1">${title}</div>
                    <div class="text-4xl font-bold">${value}</div>
                    <div class="absolute inset-y-0 right-0 w-1/5 ${barColor} opacity-20"></div>
                </div>
            `;
        }

        function renderAdminPanel() {
            if (state.user.role !== 'admin') { return renderUnauthorized(); }
            
            return `
                <div class="max-w-7xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Admin Control Panel</h2>

                    <!-- Tab Navigation -->
                    <div class="flex space-x-2 border-b border-gray-200 mb-6">
                        ${renderAdminTabButton('students', 'Student Management')}
                        ${renderAdminTabButton('grades', 'Grade Entry')}
                        ${renderAdminTabButton('attendance', 'Attendance & Permission')}
                        ${renderAdminTabButton('home_cms', 'Home Page CMS')}
                    </div>

                    <!-- Tab Content Area -->
                    <div id="admin-content-area" class="card p-6">
                        <!-- Content rendered by renderAdminContent() -->
                    </div>
                </div>
            `;
        }

        function renderAdminTabButton(tabName, label) {
            const isActive = state.activeAdminTab === tabName;
            return `<button class="tab-button ${isActive ? 'active' : 'text-gray-600 hover:bg-gray-100'}" 
                            onclick="setActiveAdminTab('${tabName}')">${label}</button>`;
        }

        function setActiveAdminTab(tabName) {
            state.activeAdminTab = tabName;
            renderAdminContent();
        }
        
        // --- ADMIN SUB-RENDERING ---

        function renderAdminContent() {
            const contentArea = document.getElementById('admin-content-area');
            if (!contentArea) return;

            let contentHtml = '';
            
            switch (state.activeAdminTab) {
                case 'students':
                    contentHtml = renderStudentManagement();
                    break;
                case 'grades':
                    contentHtml = renderGradeManagement();
                    break;
                case 'attendance':
                    contentHtml = renderAttendanceManagement();
                    break;
                case 'home_cms':
                    contentHtml = renderHomeCMS();
                    break;
            }
            contentArea.innerHTML = contentHtml;
        }

        function renderStudentManagement() {
            return `
                <h3 class="text-2xl font-semibold mb-4">Manage Students</h3>

                <!-- Add New Student Form -->
                <div class="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-200">
                    <h4 class="text-xl font-medium mb-3 text-blue-800">Add New Student</h4>
                    <form onsubmit="event.preventDefault(); addStudent(this);" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" name="name" placeholder="Full Name" required class="p-2 border rounded-lg">
                        <input type="text" name="username" placeholder="Username (for login)" required class="p-2 border rounded-lg">
                        <input type="password" name="password" placeholder="Password" required class="p-2 border rounded-lg">
                        <button type="submit" class="btn-primary">Add Student</button>
                    </form>
                    <p id="student-msg" class="mt-2 text-sm text-green-700"></p>
                </div>

                <!-- Student List Table -->
                <h4 class="text-xl font-medium mb-3 mt-8">Current Students (${data.students.length})</h4>
                <table class="min-w-full divide-y divide-gray-200 card shadow-none">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${data.students.map(s => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${s.id}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${s.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${s.username}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button onclick="deleteStudent('${s.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderGradeManagement() {
            const studentOptions = data.students.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('');

            return `
                <h3 class="text-2xl font-semibold mb-4">Enter/Update Student Grades</h3>

                <!-- Add Grade Form -->
                <div class="bg-green-50 p-4 rounded-lg mb-6 border border-green-200">
                    <h4 class="text-xl font-medium mb-3 text-green-800">Record Grade</h4>
                    <form onsubmit="event.preventDefault(); addGrade(this);" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <select name="studentId" required class="p-2 border rounded-lg bg-white">
                            <option value="">-- Select Student --</option>
                            ${studentOptions}
                        </select>
                        <input type="text" name="subject" placeholder="Subject Name (e.g., Physics)" required class="p-2 border rounded-lg">
                        <input type="text" name="grade" placeholder="Grade (e.g., A+, 92%)" required class="p-2 border rounded-lg">
                        <button type="submit" class="btn-primary bg-green-500 hover:bg-green-700">Add Grade</button>
                    </form>
                    <p id="grade-msg" class="mt-2 text-sm text-green-700"></p>
                </div>

                <!-- Current Grades Display -->
                <h4 class="text-xl font-medium mb-3 mt-8">Current Grades By Student</h4>
                <div class="space-y-4">
                    ${data.students.map(s => {
                        const grades = data.grades[s.id] || [];
                        return `
                            <div class="border p-4 rounded-lg">
                                <h5 class="font-bold text-lg mb-2">${s.name} (${s.id})</h5>
                                ${grades.length > 0 ? `
                                    <ul class="list-disc list-inside text-sm">
                                        ${grades.map(g => `<li>${g.subject}: <strong>${g.grade}</strong></li>`).join('')}
                                    </ul>
                                ` : '<p class="text-gray-500 text-sm">No grades recorded.</p>'}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function renderAttendanceManagement() {
            const studentOptions = data.students.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('');

            return `
                <h3 class="text-2xl font-semibold mb-4">Record Attendance & Permissions</h3>

                <!-- Attendance/Permission Entry Form -->
                <div class="bg-yellow-50 p-4 rounded-lg mb-6 border border-yellow-200">
                    <h4 class="text-xl font-medium mb-3 text-yellow-800">Record Status for a Date</h4>
                    <form onsubmit="event.preventDefault(); recordAttendance(this);" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <select name="studentId" required class="p-2 border rounded-lg bg-white">
                            <option value="">-- Select Student --</option>
                            ${studentOptions}
                        </select>
                        <input type="date" name="date" value="${new Date().toISOString().slice(0, 10)}" required class="p-2 border rounded-lg">
                        <select name="status" required class="p-2 border rounded-lg bg-white">
                            <option value="Present">Present</option>
                            <option value="Absent">Absent</option>
                            <option value="Daily Permission">Daily Permission</option>
                            <option value="Permanent Permission">Permanent Permission</option>
                        </select>
                        <input type="text" name="reason" placeholder="Reason (for Permission/Absent)" class="p-2 border rounded-lg">
                        <button type="submit" class="btn-primary col-span-1 md:col-span-4 bg-yellow-500 hover:bg-yellow-700">Record Attendance</button>
                    </form>
                    <p id="attendance-msg" class="mt-2 text-sm text-green-700"></p>
                </div>

                <!-- Attendance Summary Table -->
                <h4 class="text-xl font-medium mb-3 mt-8">Attendance Summary</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 card shadow-none">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Present</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Absent</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Permission</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${data.students.map(s => {
                                const records = data.attendance[s.id] || [];
                                const summary = records.reduce((acc, entry) => {
                                    if (entry.status === 'Present') acc.present++;
                                    else if (entry.status === 'Absent') acc.absent++;
                                    else if (entry.status.includes('Permission')) acc.permission++;
                                    return acc;
                                }, { present: 0, absent: 0, permission: 0 });
                                
                                // Last 5 permissions/absences for detail
                                const lastDetails = records.filter(r => r.status !== 'Present').slice(-5).reverse().map(r => 
                                    `${r.date} (${r.status}${r.reason ? ': ' + r.reason : ''})`
                                ).join('<br>');

                                return `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${s.name}</td>
                                        <td class="px-6 py-4 text-center text-sm text-green-600 font-bold">${summary.present}</td>
                                        <td class="px-6 py-4 text-center text-sm text-red-600 font-bold">${summary.absent}</td>
                                        <td class="px-6 py-4 text-center text-sm text-yellow-600 font-bold">${summary.permission}</td>
                                        <td class="px-6 py-4 text-sm text-gray-700">${lastDetails || 'No recent details.'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderHomeCMS() {
            const home = data.homeContent;
            return `
                <h3 class="text-2xl font-semibold mb-4">Home Page Content Management</h3>
                <div class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
                    <form onsubmit="event.preventDefault(); updateHomeContent(this);">
                        <div class="mb-4">
                            <label for="cms-title" class="block text-sm font-medium text-gray-700">Page Title</label>
                            <input type="text" id="cms-title" name="title" value="${home.title}" required class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="mb-4">
                            <label for="cms-body" class="block text-sm font-medium text-gray-700">Page Body Text</label>
                            <textarea id="cms-body" name="body" rows="3" required class="w-full p-2 border rounded-lg">${home.body}</textarea>
                        </div>
                        <div class="mb-4">
                            <label for="cms-features" class="block text-sm font-medium text-gray-700">Features (One per line)</label>
                            <textarea id="cms-features" name="features" rows="5" required class="w-full p-2 border rounded-lg">${home.features.join('\n')}</textarea>
                        </div>
                        <button type="submit" class="btn-primary bg-purple-600 hover:bg-purple-800">Save Home Page Content</button>
                    </form>
                    <p id="cms-msg" class="mt-2 text-sm text-green-700"></p>
                </div>
                <button class="text-blue-500 hover:text-blue-700 font-medium mt-4" onclick="navigate('home')">
                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    Preview Home Page
                </button>
            `;
        }

        function renderUnauthorized() {
            return `
                <div class="max-w-md mx-auto card p-8 text-center bg-red-50 border border-red-200">
                    <h2 class="text-3xl font-bold text-red-700 mb-4">Access Denied</h2>
                    <p class="text-red-600 mb-6">You are not authorized to view this page. Please log in with the correct credentials.</p>
                    <button class="btn-primary bg-red-500 hover:bg-red-700" onclick="navigate('login')">Go to Login</button>
                </div>
            `;
        }

        // --- ADMIN ACTION HANDLERS ---
        
        function addStudent(form) {
            const formData = new FormData(form);
            const newStudent = {
                id: generateId('S'),
                name: formData.get('name'),
                username: formData.get('username'),
                password: formData.get('password'),
            };

            if (data.students.some(s => s.username === newStudent.username) || data.admins.some(a => a.username === newStudent.username)) {
                document.getElementById('student-msg').textContent = 'Error: Username already exists.';
                document.getElementById('student-msg').className = 'mt-2 text-sm text-red-700';
                return;
            }

            data.students.push(newStudent);
            data.grades[newStudent.id] = [];
            data.attendance[newStudent.id] = [];
            saveData();
            form.reset();
            document.getElementById('student-msg').textContent = `Success: Student ${newStudent.name} added (ID: ${newStudent.id}).`;
            document.getElementById('student-msg').className = 'mt-2 text-sm text-green-700';
            renderAdminContent();
        }

        function deleteStudent(studentId) {
            if (!confirm('Are you sure you want to delete this student and ALL their data?')) return;
            data.students = data.students.filter(s => s.id !== studentId);
            delete data.grades[studentId];
            delete data.attendance[studentId];
            saveData();
            renderAdminContent();
        }

        function addGrade(form) {
            const formData = new FormData(form);
            const studentId = formData.get('studentId');
            const newGrade = {
                subject: formData.get('subject'),
                grade: formData.get('grade'),
            };

            if (!data.grades[studentId]) {
                data.grades[studentId] = [];
            }

            // Check if subject already exists for the student and update it
            const existingGradeIndex = data.grades[studentId].findIndex(g => g.subject.toLowerCase() === newGrade.subject.toLowerCase());
            if (existingGradeIndex > -1) {
                data.grades[studentId][existingGradeIndex] = newGrade; // Update existing
                document.getElementById('grade-msg').textContent = `Success: Grade for ${newGrade.subject} updated for student ID ${studentId}.`;
            } else {
                data.grades[studentId].push(newGrade); // Add new
                document.getElementById('grade-msg').textContent = `Success: Grade for ${newGrade.subject} added for student ID ${studentId}.`;
            }
            
            saveData();
            form.reset();
            document.getElementById('grade-msg').className = 'mt-2 text-sm text-green-700';
            renderAdminContent();
        }

        function recordAttendance(form) {
            const formData = new FormData(form);
            const studentId = formData.get('studentId');
            const newRecord = {
                date: formData.get('date'),
                status: formData.get('status'),
                reason: formData.get('reason'),
            };

            if (!data.attendance[studentId]) {
                data.attendance[studentId] = [];
            }
            
            // Prevent duplicate entries for the same date
            const existingIndex = data.attendance[studentId].findIndex(r => r.date === newRecord.date);
            if (existingIndex > -1) {
                data.attendance[studentId][existingIndex] = newRecord; // Overwrite
                document.getElementById('attendance-msg').textContent = `Attendance for ${newRecord.date} updated for student ID ${studentId}.`;
            } else {
                data.attendance[studentId].push(newRecord);
                document.getElementById('attendance-msg').textContent = `Attendance for ${newRecord.date} recorded for student ID ${studentId}.`;
            }

            saveData();
            form.querySelector('input[name="reason"]').value = ''; // Clear reason field only
            document.getElementById('attendance-msg').className = 'mt-2 text-sm text-green-700';
            renderAdminContent();
        }

        function updateHomeContent(form) {
            const formData = new FormData(form);
            data.homeContent.title = formData.get('title');
            data.homeContent.body = formData.get('body');
            data.homeContent.features = formData.get('features').split('\n').map(f => f.trim()).filter(f => f);

            saveData();
            document.getElementById('cms-msg').textContent = 'Home Page Content Saved Successfully!';
            setTimeout(() => document.getElementById('cms-msg').textContent = '', 3000);
        }

        // --- INITIALIZATION ---
        function init() {
            // Check if there is a logged-in state saved (optional, but good practice)
            // For this simple demo, we rely only on the current session state.
            
            // If the user lands on the site, go to the home page.
            if (!state.isLoggedIn) {
                navigate('home');
            } else if (state.user.role === 'admin') {
                navigate('admin');
            } else {
                navigate('student');
            }
            updateUI();
        }

        // Start the application
        window.onload = init;
    </script>
</body>
</html>